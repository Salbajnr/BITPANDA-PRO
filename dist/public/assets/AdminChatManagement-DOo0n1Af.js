import{W as $,u as H,a as Y,b as G,r,c as z,d as p,j as e,C as I,h as P,i as U,l as R,T as X,e as Z,f as b,g as ee,X as O,Y as B,_ as se,q as c,E as te,$ as _,a0 as ae,I as ne,a1 as ie,a2 as m,a3 as re,B as le}from"./index-locF26TT.js";import{M as ce}from"./message-square-C8zpVQLp.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const de=$("File",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const oe=$("Paperclip",[["path",{d:"m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.48",key:"1u3ebp"}]]);function he(){const{user:x}=H(),{toast:d}=Y(),l=G(),w=r.useRef(null),S=r.useRef(null),g=r.useRef(null),[o,D]=r.useState("waiting"),[a,f]=r.useState(null),[u,k]=r.useState(""),[i,j]=r.useState(null),[h,N]=r.useState(!1),{data:K,isLoading:W}=z({queryKey:["/api/support/chat/admin/sessions",o],queryFn:()=>m(`/api/support/chat/admin/sessions?status=${o}`),refetchInterval:5e3}),{data:C=[]}=z({queryKey:["/api/support/chat/messages",a?.id],queryFn:()=>m(`/api/support/chat/messages/${a?.id}`),enabled:!!a?.id,refetchInterval:2e3});r.useEffect(()=>{if(!a?.id)return;const s=new WebSocket(`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/ws/chat`);return g.current=s,s.onopen=()=>{console.log("ðŸ’¬ Admin Chat WebSocket connected"),s.send(JSON.stringify({type:"authenticate",userId:x?.id,role:"admin"})),s.send(JSON.stringify({type:"join_session",sessionId:a.id,userId:x?.id}))},s.onmessage=t=>{try{const n=JSON.parse(t.data);n.type==="new_message"?l.invalidateQueries({queryKey:["/api/support/chat/messages",a.id]}):n.type==="session_status_changed"&&l.invalidateQueries({queryKey:["/api/support/chat/admin/sessions"]})}catch(n){console.error("Error parsing WebSocket message:",n)}},s.onclose=()=>{console.log("ðŸ’¬ Admin Chat WebSocket disconnected")},()=>{s.readyState===WebSocket.OPEN&&(s.send(JSON.stringify({type:"leave_session"})),s.close())}},[a?.id,x?.id,l]),r.useEffect(()=>{w.current?.scrollIntoView({behavior:"smooth"})},[C]);const y=p({mutationFn:s=>m("/api/support/chat/admin/assign",{method:"POST",body:{sessionId:s}}),onSuccess:()=>{d({title:"Session assigned",description:"You have been assigned to this chat session"}),l.invalidateQueries({queryKey:["/api/support/chat/admin/sessions"]})},onError:s=>{d({title:"Error",description:s.message||"Failed to assign session",variant:"destructive"})}}),v=p({mutationFn:async s=>{const t=await m("/api/support/chat/message",{method:"POST",body:{sessionId:a?.id,message:s.message,attachmentUrl:s.attachmentUrl,attachmentName:s.attachmentName,attachmentSize:s.attachmentSize,messageType:s.attachmentUrl?"file":"text"}});return g.current?.readyState===WebSocket.OPEN&&g.current.send(JSON.stringify({type:"send_message",sessionId:a?.id,message:s.message,attachmentUrl:s.attachmentUrl,messageType:s.attachmentUrl?"file":"text"})),t},onSuccess:()=>{k(""),j(null),l.invalidateQueries({queryKey:["/api/support/chat/messages",a?.id]})},onError:s=>{d({title:"Error",description:s.message||"Failed to send message",variant:"destructive"})}}),Q=p({mutationFn:async s=>{const t=new FormData;t.append("file",s),t.append("type","chat_attachment");const n=await fetch("/api/upload",{method:"POST",body:t});if(!n.ok)throw new Error("Upload failed");return n.json()}}),M=p({mutationFn:()=>m("/api/support/chat/end",{method:"POST",body:{sessionId:a?.id}}),onSuccess:()=>{d({title:"Session ended",description:"Chat session has been ended"}),f(null),l.invalidateQueries({queryKey:["/api/support/chat/admin/sessions"]})}}),L=s=>{y.mutate(s.id),f(s)},J=s=>{const t=s.target.files?.[0];if(t){if(t.size>10*1024*1024){d({title:"File too large",description:"Please select a file smaller than 10MB",variant:"destructive"});return}j(t)}},V=async s=>{if(s.preventDefault(),!(!u.trim()&&!i))try{let t=null;i&&(N(!0),t={attachmentUrl:(await Q.mutateAsync(i)).url,attachmentName:i.name,attachmentSize:i.size},N(!1)),await v.mutateAsync({message:u||`Sent file: ${i?.name}`,...t})}catch(t){N(!1),console.error("Error sending message:",t)}},F=s=>{if(s===0)return"0 Bytes";const t=1024,n=["Bytes","KB","MB","GB"],q=Math.floor(Math.log(s)/Math.log(t));return parseFloat((s/Math.pow(t,q)).toFixed(2))+" "+n[q]},T=s=>{const t=s.split(".").pop()?.toLowerCase();return["jpg","jpeg","png","gif","webp"].includes(t||"")?e.jsx(re,{className:"h-4 w-4"}):e.jsx(de,{className:"h-4 w-4"})},E=s=>{const t={waiting:"secondary",active:"default",ended:"outline"};return e.jsx(le,{variant:t[s]||"secondary",children:s.toUpperCase()})},A=K?.sessions||[];return W?e.jsxs("div",{className:"space-y-6 animate-pulse",children:[e.jsx("div",{className:"h-8 bg-slate-200 dark:bg-slate-700 rounded w-1/3"}),e.jsx("div",{className:"h-96 bg-slate-200 dark:bg-slate-700 rounded"})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-slate-900 dark:text-white",children:"Chat Management"}),e.jsx("p",{className:"text-slate-600 dark:text-slate-400 mt-1",children:"Manage customer support chat sessions"})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"lg:col-span-1",children:e.jsxs(I,{className:"h-[700px]",children:[e.jsx(P,{children:e.jsx(U,{children:"Chat Sessions"})}),e.jsx(R,{className:"p-0",children:e.jsxs(X,{value:o,onValueChange:s=>D(s),children:[e.jsxs(Z,{className:"w-full",children:[e.jsx(b,{value:"waiting",children:"Waiting"}),e.jsx(b,{value:"active",children:"Active"}),e.jsx(b,{value:"ended",children:"Ended"})]}),e.jsx(ee,{value:o,className:"mt-0",children:e.jsx(O,{className:"h-[600px]",children:A.length===0?e.jsxs("div",{className:"p-4 text-center text-muted-foreground",children:[e.jsx(ce,{className:"h-12 w-12 mx-auto mb-2 opacity-50"}),e.jsxs("p",{children:["No ",o," sessions"]})]}):e.jsx("div",{className:"space-y-2 p-2",children:A.map(s=>e.jsxs("div",{className:`p-3 rounded-lg border cursor-pointer transition-colors ${a?.id===s.id?"bg-primary/10 border-primary":"hover:bg-slate-50 dark:hover:bg-slate-800"}`,onClick:()=>f(s),children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(B,{className:"h-4 w-4"}),e.jsxs("span",{className:"font-medium text-sm",children:[s.user.firstName," ",s.user.lastName]})]}),E(s.status)]}),e.jsx("p",{className:"text-sm font-medium mb-1 line-clamp-2",children:s.subject}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground mb-2",children:[e.jsx(se,{className:"h-3 w-3"}),e.jsx("span",{children:new Date(s.startedAt).toLocaleString()})]}),s.status==="waiting"&&e.jsx(c,{size:"sm",onClick:t=>{t.stopPropagation(),L(s)},disabled:y.isPending,className:"w-full",children:y.isPending?"Assigning...":"Take Session"}),s.agentName&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Agent: ",s.agentName]}),s.rating&&e.jsx("div",{className:"flex items-center gap-1 mt-1",children:[...Array(5)].map((t,n)=>e.jsx(te,{className:`h-3 w-3 ${n<s.rating?"text-yellow-400 fill-current":"text-gray-300"}`},n))})]},s.id))})})})]})})]})}),e.jsx("div",{className:"lg:col-span-2",children:e.jsxs(I,{className:"h-[700px] flex flex-col",children:[e.jsxs(P,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(U,{className:"flex items-center gap-2",children:[e.jsx(_,{className:"h-5 w-5"}),a?e.jsxs(e.Fragment,{children:["Chat with ",a.user.firstName," ",a.user.lastName,E(a.status)]}):"Select a chat session"]}),a&&a.status==="active"&&e.jsx(c,{variant:"destructive",size:"sm",onClick:()=>M.mutate(),disabled:M.isPending,children:"End Chat"})]}),a&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Subject: ",a.subject]})]}),e.jsx(R,{className:"flex-1 flex flex-col",children:a?e.jsxs(e.Fragment,{children:[e.jsx(O,{className:"flex-1 p-4 bg-slate-50 dark:bg-slate-800 rounded-lg mb-4",children:e.jsxs("div",{className:"space-y-4",children:[C.map(s=>e.jsx("div",{className:`flex ${s.senderRole==="admin"?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[70%] rounded-lg p-3 ${s.senderRole==="admin"?"bg-primary text-white":"bg-white dark:bg-slate-700 border"}`,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(B,{className:"h-4 w-4"}),e.jsxs("span",{className:"text-xs font-medium",children:[s.senderName," (",s.senderRole,")"]})]}),e.jsx("p",{className:"text-sm mb-2",children:s.message}),s.attachmentUrl&&e.jsx("div",{className:"mt-2 p-2 rounded bg-black/10 dark:bg-white/10",children:e.jsxs("div",{className:"flex items-center gap-2",children:[T(s.attachmentName||""),e.jsx("span",{className:"text-xs font-medium truncate flex-1",children:s.attachmentName}),s.attachmentSize&&e.jsx("span",{className:"text-xs opacity-75",children:F(s.attachmentSize)}),e.jsx(c,{size:"sm",variant:"ghost",onClick:()=>window.open(s.attachmentUrl,"_blank"),className:"h-6 w-6 p-0",children:e.jsx(ae,{className:"h-3 w-3"})})]})}),e.jsx("p",{className:"text-xs opacity-75 mt-1",children:new Date(s.createdAt).toLocaleTimeString()})]})},s.id)),e.jsx("div",{ref:w})]})}),i&&e.jsx("div",{className:"p-3 border rounded-lg bg-slate-50 dark:bg-slate-800 mb-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[T(i.name),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:i.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:F(i.size)})]})]}),e.jsx(c,{size:"sm",variant:"ghost",onClick:()=>j(null),children:"Ã—"})]})}),a.status==="active"&&e.jsx("form",{onSubmit:V,className:"space-y-3",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(ne,{value:u,onChange:s=>k(s.target.value),placeholder:"Type your message...",disabled:v.isPending||h,className:"flex-1"}),e.jsx("input",{type:"file",ref:S,onChange:J,className:"hidden",accept:"image/*,.pdf,.doc,.docx,.txt"}),e.jsx(c,{type:"button",variant:"outline",onClick:()=>S.current?.click(),disabled:h,children:e.jsx(oe,{className:"h-4 w-4"})}),e.jsx(c,{type:"submit",disabled:v.isPending||h||!u.trim()&&!i,children:h?"Uploading...":e.jsx(ie,{className:"h-4 w-4"})})]})})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-muted-foreground",children:[e.jsx(_,{className:"h-16 w-16 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"Select a chat session to start chatting"})]})})})]})})]})]})}export{he as default};
